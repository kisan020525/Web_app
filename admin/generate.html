<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Content - AngyOne Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="icon" href="../assets/img/logo.png">
</head>

<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h1>üìä AngyOne <span>ADMIN</span></h1>
            </div>

            <nav class="nav-section">
                <div class="nav-label">Main</div>
                <a href="index.html" class="nav-item">
                    <span class="nav-icon">üè†</span> Dashboard
                </a>
                <a href="generate.html" class="nav-item active">
                    <span class="nav-icon">‚ú®</span> Generate Content
                </a>
            </nav>

            <nav class="nav-section">
                <div class="nav-label">Content</div>
                <a href="pages.html" class="nav-item">
                    <span class="nav-icon">üìÑ</span> All Pages
                </a>
                <a href="subscribers.html" class="nav-item">
                    <span class="nav-icon">‚úâÔ∏è</span> Subscribers
                </a>
            </nav>

            <nav class="nav-section" style="margin-top: auto; padding-top: 24px; border-top: 1px solid var(--border);">
                <a href="../index.html" class="nav-item" target="_blank">
                    <span class="nav-icon">üåê</span> View Site
                </a>
                <a href="#" class="nav-item" onclick="logout()">
                    <span class="nav-icon">üö™</span> Logout
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">‚ú® Generate Content</h1>
                <p class="page-subtitle">Enter a topic and let AI create a full article for you.</p>
            </div>

            <!-- Generator Form -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">New Article</h3>
                </div>

                <form id="generate-form">
                    <div class="form-group">
                        <label class="form-label">Topic / Headline</label>
                        <input type="text" id="topic" class="form-input"
                            placeholder="e.g., OpenAI's New GPT-5 Model Capabilities" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Gemini API Key</label>
                        <input type="password" id="api-key" class="form-input" placeholder="Enter your Gemini API key"
                            required>
                        <small style="color: var(--text-muted); font-size: 0.8rem;">
                            Get key from: <a href="https://aistudio.google.com/apikey" target="_blank"
                                style="color: var(--accent);">Google AI Studio</a>
                        </small>
                    </div>

                    <button type="submit" class="btn btn-primary" id="generate-btn">
                        ‚ú® Generate Article
                    </button>
                </form>
            </div>

            <!-- Preview -->
            <div class="card" id="preview-section" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">üìÑ Preview</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary btn-sm" id="publish-btn" onclick="publishArticle()">
                            üöÄ Publish to Site
                        </button>
                        <button class="btn btn-ghost btn-sm" onclick="copyHTML()">
                            üìã Copy HTML
                        </button>
                    </div>
                </div>
                <div id="preview-content"
                    style="background: var(--bg-dark); border-radius: 8px; padding: 20px; max-height: 500px; overflow-y: auto;">
                </div>
            </div>

            <!-- Status -->
            <div id="status-message" style="margin-top: 20px; display: none;"></div>
        </main>
    </div>

    <script>
        // Auth check
        if (sessionStorage.getItem('admin_auth') !== 'true') {
            window.location.href = 'login.html';
        }

        function logout() {
            sessionStorage.removeItem('admin_auth');
            window.location.href = 'login.html';
        }

        let generatedHTML = '';
        let generatedSlug = '';

        document.getElementById('generate-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const topic = document.getElementById('topic').value;
            const apiKey = document.getElementById('api-key').value;
            const btn = document.getElementById('generate-btn');
            const status = document.getElementById('status-message');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Generating...';
            status.style.display = 'block';
            status.innerHTML = '<p style="color: var(--warning);">‚è≥ AI is writing your article... This may take 30-60 seconds.</p>';

            try {
                // Generate slug
                generatedSlug = topic.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .substring(0, 50);

                const today = new Date().toISOString().split('T')[0];

                // Call Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are a tech journalist. Write a complete, professional HTML article about: "${topic}"

IMPORTANT: Output ONLY the HTML code, no markdown, no explanation.

Use this exact template structure:
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${topic} - AngyOne News</title>
    <meta name="description" content="[Write 155 char description]">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="icon" href="../assets/img/logo.png">
    <style>
        .news-header { text-align: center; padding: 20px 0; background: white; border-bottom: 1px solid #e9ecef; }
        .news-container { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
        .article-meta { font-family: 'Inter', sans-serif; color: #6c757d; font-size: 0.9rem; margin-bottom: 24px; display: flex; gap: 16px; align-items: center; }
        .live-badge { background: #6366f1; color: white; font-weight: 700; padding: 4px 12px; border-radius: 20px; text-transform: uppercase; font-size: 0.75rem; }
        .article-title { font-family: 'Merriweather', serif; font-size: 2.5rem; line-height: 1.3; margin-bottom: 20px; color: #212529; }
        .article-subtitle { font-size: 1.25rem; color: #495057; line-height: 1.6; margin-bottom: 32px; }
        .article-body { font-family: 'Merriweather', serif; font-size: 1.1rem; line-height: 1.9; color: #212529; }
        .article-body h2 { font-family: 'Inter', sans-serif; font-size: 1.5rem; margin-top: 40px; margin-bottom: 20px; color: #212529; }
        .article-body p { margin-bottom: 24px; }
        .key-points { background: #fff8e1; border-left: 4px solid #ffc107; padding: 20px 24px; margin: 32px 0; border-radius: 0 8px 8px 0; }
        .key-points h3 { font-family: 'Inter', sans-serif; font-size: 1rem; margin-bottom: 12px; color: #212529; }
        .key-points ul { margin: 0; padding-left: 20px; }
        .key-points li { margin-bottom: 8px; font-family: 'Inter', sans-serif; font-size: 0.95rem; }
    </style>
</head>
<body>
    <nav class="news-header">
        <a href="../index.html" style="display: inline-flex; align-items: center; gap: 12px; font-size: 1.5rem; text-decoration: none; color: #000; font-weight: 700; font-family: 'Inter', sans-serif;">
            <img src="../assets/img/logo.png" alt="AngyOne" style="height: 70px; width: auto;">
            AngyOne <span style="font-weight: 300; color: #868e96;">Intelligence</span>
        </a>
    </nav>
    
    <main class="news-container">
        <div class="article-meta">
            <span class="live-badge">Trending Now</span>
            <time>${today}</time>
            <span>‚Ä¢</span>
            <span>3 min read</span>
        </div>
        
        <h1 class="article-title">[Catchy headline based on topic]</h1>
        <p class="article-subtitle">[Compelling 2-sentence summary]</p>
        
        <div class="key-points">
            <h3>‚ö° Quick Summary:</h3>
            <ul>
                <li>[Key point 1]</li>
                <li>[Key point 2]</li>
                <li>[Key point 3]</li>
                <li>[Key point 4]</li>
            </ul>
        </div>
        
        <article class="article-body">
            <p>[Opening paragraph - hook the reader]</p>
            
            <h2>[Section 1 Title]</h2>
            <p>[2-3 paragraphs of content]</p>
            
            <h2>[Section 2 Title]</h2>
            <p>[2-3 paragraphs of content]</p>
            
            <h2>What This Means</h2>
            <p>[Analysis and implications]</p>
            
            <h2>Looking Ahead</h2>
            <p>[Future outlook and conclusion]</p>
        </article>
    </main>
</body>
</html>

Write engaging, factual content. Be professional but accessible. Include real-world implications.`
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || 'API Error');
                }

                const data = await response.json();
                generatedHTML = data.candidates[0].content.parts[0].text;

                // Clean up markdown code blocks if present
                generatedHTML = generatedHTML.replace(/```html\n?/g, '').replace(/```\n?/g, '');

                // Show preview
                document.getElementById('preview-section').style.display = 'block';
                document.getElementById('preview-content').innerHTML = `<iframe srcdoc="${generatedHTML.replace(/"/g, '&quot;')}" style="width: 100%; height: 400px; border: none; border-radius: 8px; background: white;"></iframe>`;

                status.innerHTML = '<p style="color: var(--success);">‚úÖ Article generated! Preview above. Click "Publish" to go live.</p>';

            } catch (err) {
                status.innerHTML = `<p style="color: var(--danger);">‚ùå Error: ${err.message}</p>`;
            }

            btn.disabled = false;
            btn.innerHTML = '‚ú® Generate Article';
        });

        function copyHTML() {
            navigator.clipboard.writeText(generatedHTML);
            alert('HTML copied to clipboard!');
        }

        async function publishArticle() {
            const status = document.getElementById('status-message');
            const btn = document.getElementById('publish-btn');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Publishing...';
            status.innerHTML = '<p style="color: var(--warning);">‚è≥ Publishing to GitHub...</p>';

            // For now, download the file (GitHub API requires token)
            const blob = new Blob([generatedHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${generatedSlug}/index.html`;
            a.click();

            status.innerHTML = `<p style="color: var(--success);">‚úÖ HTML downloaded! Upload to <code>trends/${generatedSlug}/</code> folder in GitHub.</p>`;
            btn.disabled = false;
            btn.innerHTML = 'üöÄ Publish to Site';
        }
    </script>
</body>

</html>