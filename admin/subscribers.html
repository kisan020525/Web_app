<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscribers - AngyOne Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="icon" href="../assets/img/logo.png">
</head>

<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h1>üìä AngyOne <span>ADMIN</span></h1>
            </div>

            <nav class="nav-section">
                <div class="nav-label">Main</div>
                <a href="index.html" class="nav-item">
                    <span class="nav-icon">üè†</span> Dashboard
                </a>
                <a href="generate.html" class="nav-item">
                    <span class="nav-icon">‚ú®</span> Generate Content
                </a>
            </nav>

            <nav class="nav-section">
                <div class="nav-label">Content</div>
                <a href="pages.html" class="nav-item">
                    <span class="nav-icon">üìÑ</span> All Pages
                </a>
                <a href="subscribers.html" class="nav-item active">
                    <span class="nav-icon">‚úâÔ∏è</span> Subscribers
                </a>
            </nav>

            <nav class="nav-section" style="margin-top: auto; padding-top: 24px; border-top: 1px solid var(--border);">
                <a href="../index.html" class="nav-item" target="_blank">
                    <span class="nav-icon">üåê</span> View Site
                </a>
                <a href="#" class="nav-item" onclick="logout()">
                    <span class="nav-icon">üö™</span> Logout
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">‚úâÔ∏è Email Subscribers</h1>
                <p class="page-subtitle">People who signed up for your newsletter</p>
            </div>

            <!-- Stats -->
            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="stat-card">
                    <div class="stat-label">Total Subscribers</div>
                    <div class="stat-value" id="total-count">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">This Week</div>
                    <div class="stat-value" id="week-count">-</div>
                </div>
            </div>

            <!-- Subscribers Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">All Subscribers</h3>
                    <button class="btn btn-ghost btn-sm" onclick="exportCSV()">üì• Export CSV</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Source</th>
                                <th>Subscribed</th>
                            </tr>
                        </thead>
                        <tbody id="subscribers-list">
                            <tr>
                                <td colspan="3" style="text-align: center; color: var(--text-muted);">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        if (sessionStorage.getItem('admin_auth') !== 'true') {
            window.location.href = 'login.html';
        }

        function logout() {
            sessionStorage.removeItem('admin_auth');
            window.location.href = 'login.html';
        }

        let allSubscribers = [];

        async function loadSubscribers() {
            try {
                const response = await fetch('https://ecjmiokutdujydkfarxq.supabase.co/rest/v1/email_subscribers?order=subscribed_at.desc', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjam1pb2t1dGR1anlka2ZhcnhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNjQ5NzUsImV4cCI6MjA4MTY0MDk3NX0.ln5XBi1v5vW85yKdbOtnEgwcdxyR_HSF8-U5XZbsNGQ'
                    }
                });

                if (!response.ok) throw new Error('Failed to load');

                allSubscribers = await response.json();

                // Update stats
                document.getElementById('total-count').textContent = allSubscribers.length;

                // Count this week
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                const thisWeek = allSubscribers.filter(s => new Date(s.subscribed_at) > weekAgo).length;
                document.getElementById('week-count').textContent = thisWeek;

                // Render table
                const tbody = document.getElementById('subscribers-list');
                if (allSubscribers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No subscribers yet</td></tr>';
                    return;
                }

                tbody.innerHTML = allSubscribers.map(sub => {
                    const date = new Date(sub.subscribed_at).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'short', day: 'numeric'
                    });
                    return `
                        <tr>
                            <td>${sub.email}</td>
                            <td><span class="badge badge-success">${sub.source || 'homepage'}</span></td>
                            <td style="color: var(--text-muted);">${date}</td>
                        </tr>
                    `;
                }).join('');

            } catch (err) {
                document.getElementById('subscribers-list').innerHTML =
                    '<tr><td colspan="3" style="text-align: center; color: var(--danger);">Error loading subscribers. Make sure the table exists in Supabase.</td></tr>';
            }
        }

        function exportCSV() {
            if (allSubscribers.length === 0) {
                alert('No subscribers to export');
                return;
            }

            const csv = 'Email,Source,Subscribed At\n' +
                allSubscribers.map(s => `${s.email},${s.source || 'homepage'},${s.subscribed_at}`).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'angyone-subscribers.csv';
            a.click();
        }

        loadSubscribers();
    </script>
</body>

</html>